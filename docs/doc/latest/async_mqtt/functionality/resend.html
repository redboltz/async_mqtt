<!DOCTYPE html>
<html lang="en">
  <head>
        <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<style>html.fonts-loading{visibility:hidden;opacity:0}</style>
<script>document.documentElement.classList.add('fonts-loading');</script>

<link rel="preload" href="../../_/font/NotoSansDisplay.woff2" as="font" type="font/woff2" crossorigin="anonymous" />
<link rel="preload" href="../../_/font/NotoSansDisplay-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous" />
<link rel="preload" href="../../_/font/MonaspaceNeon-Var.woff2" as="font" type="font/woff2" crossorigin="anonymous" />
<link rel="preload" href="../../_/font/MonaspaceXenon-Var.woff2" as="font" type="font/woff2" crossorigin="anonymous" />

<script>
(function() {
  'use strict';
  
  var revealed = false;
  
  var reveal = function() {
    if (revealed) return;
    revealed = true;
    document.documentElement.classList.remove('fonts-loading');
  };
  
  setTimeout(reveal, 3000);
  
  if (!('FontFace' in window) || !('fonts' in document)) {
    setTimeout(reveal, 100);
    return;
  }
  
  var uiRoot = '../../_';
  var fonts = [
    { 
      family: 'Noto Sans', 
      url: uiRoot + '/font/NotoSansDisplay.woff2',
      descriptors: { style: 'normal', weight: '100 900', stretch: '62.5% 100%' }
    },
    { 
      family: 'Noto Sans', 
      url: uiRoot + '/font/NotoSansDisplay-Italic.woff2',
      descriptors: { style: 'italic', weight: '100 900', stretch: '62.5% 100%' }
    },
    { 
      family: 'Monaspace Neon', 
      url: uiRoot + '/font/MonaspaceNeon-Var.woff2',
      descriptors: { style: 'normal', weight: '400' }
    },
    { 
      family: 'Monaspace Xenon', 
      url: uiRoot + '/font/MonaspaceXenon-Var.woff2',
      descriptors: { style: 'italic', weight: '400' }
    }
  ];
  
  var loadPromises = fonts.map(function(f) {
    try {
      var face = new FontFace(f.family, 'url("' + f.url + '")', f.descriptors);
      return face.load().then(function(loaded) {
        document.fonts.add(loaded);
        return loaded;
      }).catch(function() {
        return null;
      });
    } catch (e) {
      return Promise.resolve(null);
    }
  });
  
  Promise.all(loadPromises)
    .then(function() {
      return document.fonts.ready;
    })
    .then(reveal)
    .catch(reveal);
})();
</script>    <title>Resend message :: async_mqtt</title>
  <link rel="canonical" href="https://antora.cppalliance.org/develop/lib/doc/async_mqtt/functionality/resend.html">
    <link rel="prev" href="keep_session.html">
    <link rel="next" href="topic_alias.html">
  <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../_/css/boostlook.css">
    <link rel="stylesheet" href="../../_/css/site.css">
    <link rel="stylesheet" href="../../_/css/vendor/tabs.css">
    <script>
    (function() {
      if (window.self !== window.top) return;
      var theme = localStorage.getItem('antora-theme');
      if (!theme && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        theme = 'dark';
      }
      if (theme === 'dark') document.documentElement.classList.add('dark');
    })();
    </script>
    <script>var uiRootPath = '../../_'</script>
<link rel="icon" href="../../_/img/favicons/favicon.ico" type="image/x-icon">
    <!-- Favicon configuration -->
    <link rel="apple-touch-icon" sizes="180x180" href="../../_/img/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../_/img/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../../_/img/favicons/favicon-16x16.png">
    <link rel="manifest" href="../../_/img/favicons/site.webmanifest">
    <link rel="shortcut icon" href="../../_/img/favicons/favicon.ico">
  </head>
  <body class="article toc2 toc-left">
    <div class="boostlook">
   <div id="header">
      <div id="toc" class="nav-container toc2" data-component="async_mqtt" data-version="">
  <aside class="nav">
    <button class="nav-close"></button>
    <div class="panels">
      <div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
      <div class="title-row">
        <h3 class="title"><a href="../index.html">async_mqtt</a></h3>
        <button class="theme-toggle" aria-label="Toggle dark mode" title="Toggle theme" style="display:none">
  <i class="fas fa-sun theme-icon-light"></i>
  <i class="fas fa-moon theme-icon-dark"></i>
</button>      </div>
      <ul class="nav-list">
        <ul class="nav-list">
        <li class="" data-depth="1">
            <a class="nav-link" href="../reference.html">Reference</a>
        </li>
              <li class="" data-depth="1">
            <span class="nav-text">History</span>
        </li>
        <ul class="nav-list">
        <li class="" data-depth="2">
            <a class="nav-link" href="../CHANGELOG.html">Changelog</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../older.html">Older versions' documents</a>
        </li>
        </ul>
        <li class="" data-depth="1">
            <span class="nav-text">Introduction</span>
        </li>
        <ul class="nav-list">
        <li class="" data-depth="2">
            <a class="nav-link" href="../requirements.html">Requirements</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../goal.html">Design Goal</a>
        </li>
        </ul>
        <li class="" data-depth="1">
            <span class="nav-text">Quick Look</span>
        </li>
        <ul class="nav-list">
        <li class="" data-depth="2">
            <a class="nav-link" href="../quicklook.html">Simple Pub/Sub client</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../performance.html">Performance</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../comparison.html">Comparison</a>
        </li>
        </ul>
        <li class="" data-depth="1">
            <span class="nav-text">Tutorial</span>
        </li>
        <ul class="nav-list">
        <li class="" data-depth="2">
            <a class="nav-link" href="../header.html">Header Files</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../tutorial/client.html">Client</a>
        </li>
              <li class="" data-depth="2">
            <span class="nav-text">Endpoint</span>
        </li>
        <ul class="nav-list">
        <li class="" data-depth="3">
            <a class="nav-link" href="../tutorial/create_endpoint.html">Create endpoint</a>
        </li>
              <li class="" data-depth="3">
            <a class="nav-link" href="../tutorial/cpp20_coro.html">C++20 coroutine</a>
        </li>
              <li class="" data-depth="3">
            <a class="nav-link" href="../tutorial/sl_coro.html">Stackless coroutine</a>
        </li>
              <li class="" data-depth="3">
            <a class="nav-link" href="../tutorial/send_recv.html">Send/Recv packets</a>
        </li>
        </ul>
  </ul>
        <li class="" data-depth="1">
            <span class="nav-text">Functionality</span>
        </li>
        <ul class="nav-list">
        <li class="" data-depth="2">
            <a class="nav-link" href="packet_based.html">Packet-Based APIs</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="non_packet_based.html">Non packet based APIs</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="packet_id.html">Packet Identifier Management</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="connect_timeout.html">Connect Timeout</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="keep_session.html">Keep session</a>
        </li>
              <li class=" is-current-page" data-depth="2">
            <a class="nav-link" href="resend.html">Resend message</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="topic_alias.html">Topic Alias</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="request_response.html">Request/Response</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="receive_maximum.html">Receive Maximum</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="maximum_packet_size.html">Maximum Packet Size</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="thread_safe.html">Thread Safety</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="logging.html">Logging</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="error_report.html">Error Reporting</a>
        </li>
        </ul>
        <li class="" data-depth="1">
            <a class="nav-link" href="../sansio.html">I/O Independent MQTT Protocol Machine</a>
        </li>
              <li class="" data-depth="1">
            <span class="nav-text">Customize/Config</span>
        </li>
        <ul class="nav-list">
        <li class="" data-depth="2">
            <a class="nav-link" href="../customize.html">Customize Underlying Layer</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../config.html">Config</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../separate.html">Separate Compilation Mode</a>
        </li>
        </ul>
        <li class="" data-depth="1">
            <span class="nav-text">Tools</span>
        </li>
        <ul class="nav-list">
        <li class="" data-depth="2">
            <a class="nav-link" href="../tool/container.html">Run async_mqtt broker/client on the docker container</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../tool/trial.html">Free trial broker on cloud</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../tool/broker.html">broker</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../tool/client_cli.html">client_cli</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../tool/bench.html">bench</a>
        </li>
        </ul>
        <li class="" data-depth="1">
            <span class="nav-text">Contribution</span>
        </li>
        <ul class="nav-list">
        <li class="" data-depth="2">
            <a class="nav-link" href="../codingrule.html">Coding Rule</a>
        </li>
        </ul>
        <li class="" data-depth="1">
            <a class="nav-link" href="http://github.com/redboltz/async_mqtt">Repository</a>
        </li>
        </ul>
  </ul>
  </nav>
</div>
    </div>
  </aside>
</div>
  </div>  <div id="content">
    <article class="doc max-width-reset">
  <div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li>
      <a href="../index.html" aria-label="Home: async_mqtt">
        <svg xmlns="http://www.w3.org/2000/svg" width="1rem" height="1rem" viewBox="0 -960 960 960" fill="#000000" aria-hidden="true"><path d="M160-120v-480l320-240 320 240v480H560v-280H400v280H160Z"/></svg>
      </a>
    </li>
    <li>Functionality</li>
    <li><a href="resend.html">Resend message</a></li>
  </ul>
</nav>
  <div class="search-container">
    <div id="search-field" class="field has-filter">
      <input id="search-input" type="text" placeholder="Search the docs" >
    </div>
  </div>
<div class="spirit-nav">
    <a accesskey="p" href="keep_session.html">
      <span class="material-symbols-outlined" title="Previous: Keep session">arrow_back</span>
    </a>
    <a class="disabled" accesskey="u" aria-disabled="true" tabindex="-1">
      <span class="material-symbols-outlined" title="Up:">arrow_upward</span>
    </a>
    <a accesskey="n" href="topic_alias.html">
      <span class="material-symbols-outlined" title="Next: Topic Alias">arrow_forward</span>
    </a>
</div></div>
    <h1 class="page">Resend message</h1>
  <div class="sect1">
<h2 id="_division_of_roles_between_mqtt_and_the_underlying_layer"><a class="anchor" href="#_division_of_roles_between_mqtt_and_the_underlying_layer"></a>Division of roles between MQTT and the underlying layer</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the MQTT protocol, retransmission is only permitted immediately after reconnection when both the client and server sessions are maintained following a disconnection. MQTT assumes that the underlying layer, such as TCP, guarantees delivery and order.
See <a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901233" class="bare">https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901233</a></p>
</div>
<div class="paragraph">
<p>Therefore, retransmission during an active MQTT connection can lead to inconsistencies with the underlying layer, which the MQTT protocol prohibits. If retransmission is not possible at the lower layer due to congestion or other conditions, the lower layer will return an error code and disconnect. MQTT detects this disconnection and, if necessary, will reconnect and retransmit the messages. In other words, MQTT ensures message delivery across disconnections.
See <a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901238" class="bare">https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901238</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_points_to_note_when_resending_message"><a class="anchor" href="#_points_to_note_when_resending_message"></a>Points to note when resending message</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The communication constraints in MQTT can vary depending on the broker. For instance, the Maximum Packet Size  might differ between brokers. This information can be found in the <code>MaximumPacketSize</code> property of the <code>CONNACK</code> packet, which is the response to the <code>CONNECT</code> packet. Even if a client believes it is reconnecting to the same broker, it might actually be redirected to a different broker with different settings. Therefore, when reconnecting, it is crucial to carefully check the contents of the CONNACK packet to avoid protocol violations.
In <code>async_mqtt</code>, if there are messages that cannot be retransmitted due to changes in broker conditions during reconnection, the messages will not be retransmitted, and an error will be notified to the user.</p>
</div>
<div class="paragraph">
<p>When you detect a disconnection using <code>async_mqtt</code>, you can simply call <code>async_underlying_handshake()</code>, wait for the result, and then send a <code>CONNECT</code> packet. Check the received <code>CONNACK</code> packet. Resending messages are automatically done after receiving the <code>CONNACK</code> packet. To avoid rapid repeated reconnections, it is a good convention to wait several seconds before calling <code>async_underlying_handshake()</code>.</p>
</div>
<div class="paragraph">
<p>Here are examples for reconnection:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>C++20 coroutine based</p>
<div class="ulist">
<ul>
<li>
<p><a href="../example/cl_cpp20coro_mqtt_sub.cpp">cl_cpp20coro_mqtt_sub.cpp</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>C++17 callback based</p>
<div class="ulist">
<ul>
<li>
<p><a href="../example/cl_cpp17_mqtt_sub.cpp">cl_cpp17_mqtt_sub.cpp</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_reconnection_with_tls_mqtts_wss"><a class="anchor" href="#_reconnection_with_tls_mqtts_wss"></a>Reconnection with TLS (mqtts, wss)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When the underlying layer involves TLS (i.e., <code>mqtts</code> or <code>wss</code>), you <strong>cannot</strong> reuse the same <code>basic_endpoint</code>, <code>endpoint</code>  or <code>client</code> object for reconnection by simply calling <code>async_underlying_handshake()</code> again.</p>
</div>
<div class="paragraph">
<p>This is because <code>boost::asio::ssl::stream</code> becomes invalid after <code>SSL_shutdown()</code> is performed during disconnection. The SSL internal state cannot be reset for a new handshake on the same object.
See <a href="https://github.com/chriskohlhoff/asio/issues/804" class="bare">https://github.com/chriskohlhoff/asio/issues/804</a></p>
</div>
<div class="paragraph">
<p>For non-TLS layers (TCP <code>mqtt</code>, WebSocket <code>ws</code>), the simple reconnection approach described above works as expected.</p>
</div>
<div class="sect2">
<h3 id="_reconnection_procedure_for_tls_layers"><a class="anchor" href="#_reconnection_procedure_for_tls_layers"></a>Reconnection procedure for TLS layers</h3>
<div class="paragraph">
<p>The simplest approach is to create a new <code>basic_endpoint</code>, <code>endpoint</code> or <code>client</code> object. If you need to maintain the MQTT session state across the reconnection, you must migrate the session state from the old object to the new one before performing the handshake.</p>
</div>
<div class="paragraph">
<p>In this example, <code>am_opt</code> is assumed to be <code>std::optional&lt;basic_endpoint&lt;&#8230;&#8203;&gt;&gt;</code>, <code>std::optional&lt;endpoint&lt;&#8230;&#8203;&gt;&gt;</code>, or <code>std::optional&lt;client&lt;&#8230;&#8203;&gt;&gt;</code>, so that <code>emplace()</code> can be used to reconstruct the object in place.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">// 1. Retrieve session state from the old endpoint/client
auto storedPackets = am_opt-&gt;get_endpoint().get_stored_packets();
auto storedPids = am_opt-&gt;get_endpoint().get_qos2_publish_handled_pids();

// 2. Create a new endpoint/client
am_opt.emplace(exec, ctx);

// 3. Restore session state to the new endpoint/client
am_opt-&gt;get_endpoint().restore_packets(std::move(storedPackets));
am_opt-&gt;get_endpoint().restore_qos2_publish_handled_pids(std::move(storedPids));

// 4. Perform the underlying handshake and send CONNECT with clean_start=false
co_await am_opt-&gt;async_underlying_handshake(host, port);</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>get_stored_packets()</code> retrieves the halfway PUBLISH (QoS1, QoS2) and PUBREL packets that have not yet been acknowledged. <code>get_qos2_publish_handled_pids()</code> retrieves the packet IDs of QoS2 PUBLISH packets that have been processed but not yet released (PUBCOMP not yet sent). These must be restored to the new object using <code>restore_packets()</code> and <code>restore_qos2_publish_handled_pids()</code> respectively, before calling <code>async_underlying_handshake()</code> and sending the <code>CONNECT</code> packet.</p>
</div>
</div>
</div>
</div>
  <div class="edit-this-page">
      <a href="file:///home/kondo/work/async_mqtt/doc/modules/ROOT/pages/functionality/resend.adoc">Edit this Page</a>
  </div>
      <nav class="pagination">
        <span class="prev"><a href="keep_session.html">Keep session</a></span>
        <span class="next"><a href="topic_alias.html">Topic Alias</a></span>
    </nav>
</article>
</div>
  <div id="footer">
  <script id="site-script" src="../../_/js/site.js" data-ui-root-path="../../_"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
<script async src="../../_/js/vendor/tabs.js" data-sync-storage-key="preferred-tab"></script>
<script async src="../../_/js/vendor/lunr.js"></script>
<script async src="../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../.."
  data-ui-root-path="../../_"></script>
<script async src="../../search-index.js"></script>
</div>
</div>
  </body>
</html>
