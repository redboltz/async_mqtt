<!DOCTYPE html>
<html lang="en">
  <head>
        <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Send/Recv packets :: async_mqtt</title>
  <link rel="canonical" href="https://antora.cppalliance.org/develop/lib/doc/async_mqtt/tutorial/send_recv.html">
    <link rel="prev" href="sl_coro.html">
    <link rel="next" href="../functionality/packet_based.html">
  <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../_/css/boostlook.css">
    <link rel="stylesheet" href="../../_/css/site.css">
    <link rel="stylesheet" href="../../_/css/vendor/tabs.css">
    <script>var uiRootPath = '../../_'</script>
<link rel="icon" href="../../_/img/favicons/favicon.ico" type="image/x-icon">
    <!-- Favicon configuration -->
    <link rel="apple-touch-icon" sizes="180x180" href="../../_/img/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../_/img/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../../_/img/favicons/favicon-16x16.png">
    <link rel="manifest" href="../../_/img/favicons/site.webmanifest">
    <link rel="shortcut icon" href="../../_/img/favicons/favicon.ico">
  </head>
  <body class="article toc2 toc-left">
    <div class="boostlook">
  <div id="header">
    <div id="toc" class="nav-container toc2" data-component="async_mqtt" data-version="">
  <aside class="nav">
    <button class="nav-close"></button>
    <div class="panels">
      <div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
      <h3 class="title"><a href="../index.html">async_mqtt</a></h3>
      <ul class="nav-list">
        <ul class="nav-list">
        <li class="" data-depth="1">
            <a class="nav-link" href="../reference.html">Reference</a>
        </li>
              <li class="" data-depth="1">
            <span class="nav-text">History</span>
        </li>
        <ul class="nav-list">
        <li class="" data-depth="2">
            <a class="nav-link" href="../CHANGELOG.html">Changelog</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../older.html">Older versions' documents</a>
        </li>
        </ul>
        <li class="" data-depth="1">
            <span class="nav-text">Introduction</span>
        </li>
        <ul class="nav-list">
        <li class="" data-depth="2">
            <a class="nav-link" href="../requirements.html">Requirements</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../goal.html">Design Goal</a>
        </li>
        </ul>
        <li class="" data-depth="1">
            <span class="nav-text">Quick Look</span>
        </li>
        <ul class="nav-list">
        <li class="" data-depth="2">
            <a class="nav-link" href="../quicklook.html">Simple Pub/Sub client</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../performance.html">Performance</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../comparison.html">Comparison</a>
        </li>
        </ul>
        <li class="" data-depth="1">
            <span class="nav-text">Tutorial</span>
        </li>
        <ul class="nav-list">
        <li class="" data-depth="2">
            <a class="nav-link" href="../header.html">Header Files</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="client.html">Client</a>
        </li>
              <li class="" data-depth="2">
            <span class="nav-text">Endpoint</span>
        </li>
        <ul class="nav-list">
        <li class="" data-depth="3">
            <a class="nav-link" href="create_endpoint.html">Create endpoint</a>
        </li>
              <li class="" data-depth="3">
            <a class="nav-link" href="cpp20_coro.html">C++20 coroutine</a>
        </li>
              <li class="" data-depth="3">
            <a class="nav-link" href="sl_coro.html">Stackless coroutine</a>
        </li>
              <li class=" is-current-page" data-depth="3">
            <a class="nav-link" href="send_recv.html">Send/Recv packets</a>
        </li>
        </ul>
  </ul>
        <li class="" data-depth="1">
            <span class="nav-text">Functionality</span>
        </li>
        <ul class="nav-list">
        <li class="" data-depth="2">
            <a class="nav-link" href="../functionality/packet_based.html">Packet-Based APIs</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../functionality/non_packet_based.html">Non packet based APIs</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../functionality/packet_id.html">Packet Identifier Management</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../functionality/connect_timeout.html">Connect Timeout</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../functionality/keep_session.html">Keep session</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../functionality/resend.html">Resend message</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../functionality/topic_alias.html">Topic Alias</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../functionality/request_response.html">Request/Response</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../functionality/receive_maximum.html">Receive Maximum</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../functionality/maximum_packet_size.html">Maximum Packet Size</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../functionality/thread_safe.html">Thread Safety</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../functionality/logging.html">Logging</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../functionality/error_report.html">Error Reporting</a>
        </li>
        </ul>
        <li class="" data-depth="1">
            <a class="nav-link" href="../sansio.html">I/O Independent MQTT Protocol Machine</a>
        </li>
              <li class="" data-depth="1">
            <span class="nav-text">Customize/Config</span>
        </li>
        <ul class="nav-list">
        <li class="" data-depth="2">
            <a class="nav-link" href="../customize.html">Customize Underlying Layer</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../config.html">Config</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../separate.html">Separate Compilation Mode</a>
        </li>
        </ul>
        <li class="" data-depth="1">
            <span class="nav-text">Tools</span>
        </li>
        <ul class="nav-list">
        <li class="" data-depth="2">
            <a class="nav-link" href="../tool/container.html">Run async_mqtt broker/client on the docker container</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../tool/trial.html">Free trial broker on cloud</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../tool/broker.html">broker</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../tool/client_cli.html">client_cli</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../tool/bench.html">bench</a>
        </li>
        </ul>
        <li class="" data-depth="1">
            <span class="nav-text">Contribution</span>
        </li>
        <ul class="nav-list">
        <li class="" data-depth="2">
            <a class="nav-link" href="../codingrule.html">Coding Rule</a>
        </li>
        </ul>
        <li class="" data-depth="1">
            <a class="nav-link" href="http://github.com/redboltz/async_mqtt">Repository</a>
        </li>
        </ul>
  </ul>
  </nav>
</div>
    </div>
  </aside>
</div>
</div>
  <div id="content">
    <article class="doc max-width-reset">
  <div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li>
      <a href="../index.html" aria-label="Home: async_mqtt">
        <svg xmlns="http://www.w3.org/2000/svg" width="1rem" height="1rem" viewBox="0 -960 960 960" fill="#000000" aria-hidden="true"><path d="M160-120v-480l320-240 320 240v480H560v-280H400v280H160Z"/></svg>
      </a>
    </li>
    <li>Tutorial</li>
    <li>Endpoint</li>
    <li><a href="send_recv.html">Send/Recv packets</a></li>
  </ul>
</nav>
<div class="spirit-nav">
    <a accesskey="p" href="sl_coro.html">
      <span class="material-symbols-outlined" title="Previous: Stackless coroutine">arrow_back</span>
    </a>
    <a class="disabled" accesskey="u" aria-disabled="true" tabindex="-1">
      <span class="material-symbols-outlined" title="Up:">arrow_upward</span>
    </a>
    <a accesskey="n" href="../functionality/packet_based.html">
      <span class="material-symbols-outlined" title="Next: Packet-Based APIs">arrow_forward</span>
    </a>
</div></div>
    <h1 class="page">Send/Recv packets</h1>
  <div class="sect1">
<h2 id="_async_recv_funtion"><a class="anchor" href="#_async_recv_funtion"></a><code><a href="../reference/async_mqtt/basic_endpoint.html" class="xref page">async_recv()</a></code> funtion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You need to call the <code><a href="../reference/async_mqtt/basic_endpoint.html" class="xref page">async_recv()</a></code> function when you want to receive MQTT packets. It is similar to Boost.Asio&#8217;s <code>async_read()</code> function, allowing you to control packet receiving timing. <code>async_mqtt</code> does not use handler registering style APIs such as <code>set_publish_handler()</code>. If you need handler registering APIs, you can create them using <code>async_recv()</code>.</p>
</div>
<div class="paragraph">
<p>The <code>async_recv()</code> function is more flexible than handler registering APIs. Additionally, it works well with the <a href="https://www.boost.org/doc/html/boost_asio/overview/model/completion_tokens.html">Completion Token</a> model.</p>
</div>
<div class="sect2">
<h3 id="_packet_variant"><a class="anchor" href="#_packet_variant"></a><code><a href="../reference/async_mqtt/packet_variant.html" class="xref page">packet_variant</a></code></h3>
<div class="paragraph">
<p>async_recv()'s CompletionToken parameters are error_code and <code><a href="../reference/async_mqtt/packet_variant.html" class="xref page">packet_variant</a></code>.</p>
</div>
<div class="paragraph">
<p>If there is no error, you can access the <code>pv</code> using the <code>visit</code> function and overloaded lambda expressions. Each lambda expression corresponds to the actual packet type.</p>
</div>
<div class="paragraph">
<p><code>packet_variant</code> is a variant type of all MQTT packets and <code>std::monostate</code>. <code>std::monostate</code> is only used if error_code is not <code>success</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>async_mqtt</code> has <code>basic_foobar</code> type and <code>foobar</code> type if the type contains MQTT&#8217;s Packet Identifier. <code>basic_foobar</code> takes a <code>PacketIdBytes</code> parameter. <code>basic_foobar&lt;2&gt;</code> is the same as <code>foobar</code>. The MQTT spec defines the size of the Packet Identifier as 2. However, some clustering brokers use an expanded Packet Identifier for inter-broker communication. General users don&#8217;t need to worry about <code>basic_foobar</code> types; simply use <code>foobar</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can access <code>packet_variant</code> as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">namespace am = async_mqtt; // always use this namespace alias in this document</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">// Let's say the completion token arguments are `error_code ec, packet_variant pv`.
if (ec) {
    std::cout
         &lt;&lt; "MQTT CONNACK recv error:"
         &lt;&lt; ec.message()
         &lt;&lt; std::endl;
}
else {
    // `pv` can be converted to boolean. If `pv` contains a valid packet, it converts to `true`;
    // otherwise (`std::monostate`) , it converts to `false`.
    BOOST_ASSERT(pv); // if ec is not an error, then pv is always converted to true
    pv.visit(
        am::overload {
             [&amp;](am::v3_1_1::connack_packet const&amp; p) {
                 std::cout
                     &lt;&lt; "MQTT CONNACK recv "
                     &lt;&lt; "sp:" &lt;&lt; p.session_present()
                     &lt;&lt; std::endl;
             },
             // other packets handling code here
             [](auto const&amp;) {}
        }
    );
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_control_packet_type_filter"><a class="anchor" href="#_control_packet_type_filter"></a>Control Packet Type filter</h3>
<div class="paragraph">
<p>You might be interested in specific packets. Your application may not need to handle non-important packets like PINGRESP, PUBACK, PUBREC, PUBREL, and PUBCOMP packets.</p>
</div>
<div class="paragraph">
<p>You can filter packets as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">// ep is endpoint shared_ptr
ep-&gt;async_recv(am::filter::match, {am::control_packet_type::publish}, completion_token);</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you set <code>filter::match</code> as the first argument, the second parameter is a list of matching MQTT Control Packet types. If unmatched packets are received, the <code>completion_token</code> isn&#8217;t invoked, but the received packets are appropriately processed. If an error occurs, the <code>completion_token</code> is invoked with a <code>ec</code> that contains the error.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">// ep is endpoint
ep-&gt;async_recv(am::filter::except, {am::control_packet_type::pingresp, am::control_packet_type::puback}, completion_token);</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you set <code>filter::except</code> as the first argument, the second parameter is a list of MQTT Control Packet types to ignore. If the packets in the list are received, the <code>completion_token</code> isn&#8217;t invoked, but the received packets are appropriately processed. If an error occurs, the <code>completion_token</code> is invoked with a <code>packet_variant</code> that contains the error.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_async_send_function"><a class="anchor" href="#_async_send_function"></a><code><a href="../reference/async_mqtt/basic_endpoint/async_send.html" class="xref page">async_send()</a></code> function</h2>
<div class="sectionbody">
<div class="paragraph">
<p>MQTT has various packet types, such as CONNECT, PUBLISH, SUBSCRIBE, and so on. To send a packet, first create the packet and then pass it as a parameter to <code>async_send()</code>. If the send timing is a protocol error, the <code>async_send()</code> <code>CompletionToken</code> is invoked with a <code>system_error</code>.</p>
</div>
<div class="paragraph">
<p>You can call <code>async_send()</code> continuously. The <code>async_mqtt</code> endpoint has a queuing mechanism. When the previous <code>async_send()</code> function&#8217;s <code>CompletionToken</code> is invoked, the next packet in the queue is sent, if it exists.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_packet_based_apis"><a class="anchor" href="#_packet_based_apis"></a>Packet Based APIs</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>async_mqtt</code> automatically updates the endpoint&#8217;s internal state when sending and receiving packets. See <a href="../functionality/packet_based.html" class="xref page">Packet Based APIs</a>.</p>
</div>
</div>
</div>
  <div class="edit-this-page">
      <a href="file:///home/kondo/work/async_mqtt/doc/modules/ROOT/pages/tutorial/send_recv.adoc">Edit this Page</a>
  </div>
      <nav class="pagination">
        <span class="prev"><a href="sl_coro.html">Stackless coroutine</a></span>
        <span class="next"><a href="../functionality/packet_based.html">Packet-Based APIs</a></span>
    </nav>
</article>
</div>
  <div id="footer">
  <script id="site-script" src="../../_/js/site.js" data-ui-root-path="../../_"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
<script async src="../../_/js/vendor/tabs.js" data-sync-storage-key="preferred-tab"></script>
</div>
</div>
  </body>
</html>
